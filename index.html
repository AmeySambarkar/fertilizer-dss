# ... (Full index.html content from previous correct version) ...
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Fertilizer DSS</title><script src="https://cdn.tailwindcss.com"></script><script src="https://d3js.org/d3.v7.min.js"></script><style> body { font-family: 'Inter', sans-serif; } .chart-container { width: 100%; overflow-x: auto; } </style></head><body class="bg-gray-100 text-gray-800"><div class="container mx-auto p-4 md:p-8 max-w-3xl"><header class="mb-8"><h1 class="text-4xl font-bold text-gray-900">Fertilizer DSS</h1><p class="text-lg text-gray-600">Optimizer Prototype</p></header><div class="bg-white p-6 rounded-lg shadow-md mb-8"> <h2 class="text-2xl font-semibold mb-4">Get Recommendation</h2> <form id="recommend-form"> <div class="grid grid-cols-1 md:grid-cols-3 gap-4"> <div><label for="field_id" class="block text-sm font-medium text-gray-700">Field ID (e.g., field_1)</label><input type="text" id="field_id" name="field_id" value="field_1" class="mt-1 block w-full input-style"></div> <div><label for="crop" class="block text-sm font-medium text-gray-700">Crop (e.g., wheat)</label><input type="text" id="crop" name="crop" value="wheat" class="mt-1 block w-full input-style"></div> <div><label for="budget" class="block text-sm font-medium text-gray-700">Budget (INR)</label><input type="number" id="budget" name="budget" value="10000" min="0" step="500" class="mt-1 block w-full input-style"></div> </div> <div class="mt-6"><button type="submit" id="submit-btn" class="w-full btn btn-blue"><span id="btn-text">Get Recommendation</span><svg id="btn-loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></button></div> </form> </div> <div class="bg-white p-6 rounded-lg shadow-md mb-8"> <h2 class="text-2xl font-semibold mb-4">Scenario Analysis (Pareto Frontier)</h2> <p class="text-gray-600 mb-4">Run optimizer for multiple budgets.</p> <button id="scenario-btn" class="w-full btn btn-green"><span id="scenario-btn-text">Run Scenario Analysis</span><svg id="scenario-loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></button> <div id="scenario-chart-container" class="mt-6 hidden"><h3 class="text-xl font-semibold mb-2">Yield vs. Budget Frontier</h3><div class="chart-container"><svg id="pareto-chart" width="600" height="300"></svg></div></div> </div> <div id="results-container" class="bg-white p-6 rounded-lg shadow-md hidden"> <div id="status-message" class="alert alert-yellow hidden"><strong class="font-bold">Status:</strong> <span id="status-text"></span></div> <div id="error-message" class="alert alert-red hidden"><strong class="font-bold">Error:</strong> <span id="error-text"></span></div> <div id="success-content" class="hidden"> <h2 class="text-2xl font-semibold mb-4">Recommendation Results</h2> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"> <div class="stat-box"><span class="stat-label">Nitrogen (N) kg/ha</span><span id="rec-n" class="stat-value text-blue-600">--</span></div> <div class="stat-box"><span class="stat-label">Phosphorus (P) kg/ha</span><span id="rec-p" class="stat-value text-blue-600">--</span></div> <div class="stat-box"><span class="stat-label">Potassium (K) kg/ha</span><span id="rec-k" class="stat-value text-blue-600">--</span></div> <div class="stat-box stat-box-highlight"><span class="stat-label">Mean Yield kg/ha</span><span id="rec-yield" class="stat-value text-blue-800">--</span></div> </div> <h3 class="text-xl font-semibold mb-2">Expected Yield Distribution (95% CI)</h3> <p class="text-sm text-gray-600 mb-4">Based on simulated risk.</p> <div class="chart-container"><svg id="yield-chart" width="600" height="120"></svg></div> </div> </div></div><style> .input-style { @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm; } .btn { @apply flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50; } .btn-blue { @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500; } .btn-green { @apply bg-green-600 hover:bg-green-700 focus:ring-green-500; } .alert { @apply px-4 py-3 rounded relative mb-4; } .alert-yellow { @apply bg-yellow-100 border border-yellow-400 text-yellow-800; } .alert-red { @apply bg-red-100 border border-red-400 text-red-700; } .stat-box { @apply bg-gray-50 p-4 rounded-lg; } .stat-label { @apply block text-sm font-medium text-gray-500; } .stat-value { @apply text-2xl font-bold; } .stat-box-highlight { @apply bg-blue-50 border border-blue-200; } </style><script>const gId=id=>document.getElementById(id),form=gId('recommend-form'),submitBtn=gId('submit-btn'),btnText=gId('btn-text'),btnLoader=gId('btn-loader'),resultsContainer=gId('results-container'),statusContainer=gId('status-message'),statusText=gId('status-text'),errorContainer=gId('error-message'),errorText=gId('error-text'),successContent=gId('success-content'),recN=gId('rec-n'),recP=gId('rec-p'),recK=gId('rec-k'),recYield=gId('rec-yield'),chartSvg=d3.select("#yield-chart"),scenarioBtn=gId('scenario-btn'),scenarioBtnText=gId('scenario-btn-text'),scenarioLoader=gId('scenario-loader'),scenarioChartContainer=gId('scenario-chart-container'),paretoSvg=d3.select("#pareto-chart");form.addEventListener('submit',async e=>{e.preventDefault();const fieldId=gId('field_id').value,crop=gId('crop').value.toLowerCase(),budget=parseFloat(gId('budget').value);setLoading(!0,"Submitting...");resultsContainer.classList.remove('hidden');successContent.classList.add('hidden');errorContainer.classList.add('hidden');statusContainer.classList.add('hidden');try{const res=await fetch('/recommend/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field_id:fieldId,budget:budget,crop:crop})}),data=await res.json();if(!res.ok)throw new Error(data.detail||'Submit failed.');showStatus(Job  submitted. Polling...);pollJobStatus(data.job_id,!0)}catch(err){showError(err.message);setLoading(!1,"Get Recommendation")}});async function pollJobStatus(jobId,updateSingle){try{const res=await fetch(/recommend/result/),data=await res.json();if(!res.ok)throw new Error(data.detail||'Polling failed.');if(data.status==='SUCCESS'){if(updateSingle){setLoading(!1,"Get Recommendation");statusContainer.classList.add('hidden');updateUI(data.data)}}else if(data.status==='FAILED'){if(updateSingle){setLoading(!1,"Get Recommendation");statusContainer.classList.add('hidden');showError(Job failed: )}}else{if(updateSingle)showStatus(Running (Status: )...);setTimeout(()=>pollJobStatus(jobId,updateSingle),2500)}}catch(err){if(updateSingle){showError(err.message);setLoading(!1,"Get Recommendation")}}} function setLoading(isLoading,message){btnText.textContent=message;submitBtn.disabled=isLoading;isLoading?btnLoader.classList.remove('hidden'):btnLoader.classList.add('hidden')}function showStatus(message){statusText.textContent=message;statusContainer.classList.remove('hidden')}function showError(message){errorText.textContent=message;errorContainer.classList.remove('hidden');successContent.classList.add('hidden');statusContainer.classList.add('hidden')}function updateUI(data){recN.textContent=data.recommended_N.toFixed(1);recP.textContent=data.recommended_P.toFixed(1);recK.textContent=data.recommended_K.toFixed(1);recYield.textContent=data.expected_yield_mean.toFixed(1);resultsContainer.classList.remove('hidden');successContent.classList.remove('hidden');errorContainer.classList.add('hidden');statusContainer.classList.add('hidden');drawYieldChart(data.expected_yield_95_ci_low,data.expected_yield_mean,data.expected_yield_95_ci_high)}function drawYieldChart(low,mean,high){chartSvg.selectAll("*").remove();const m={t:20,r:30,b:50,l:30},w=600-m.l-m.r,h=120-m.t-m.b,g=chartSvg.append("g").attr("transform",	ranslate(,)),min=low*.9,max=high*1.1,x=d3.scaleLinear().domain([min,max]).range([0,w]);g.append("g").attr("transform",	ranslate(0, )).call(d3.axisBottom(x).ticks(5)).selectAll("text").style("font-size","12px");g.append("text").attr("text-anchor","middle").attr("x",w/2).attr("y",h+40).text("Expected Yield (kg/ha)").style("font-size","14px").style("fill","#4A5568");const cy=h/2-10;g.append("rect").attr("x",x(low)).attr("y",cy-10).attr("width",x(high)-x(low)).attr("height",20).attr("fill","#C3DAFE");g.append("line").attr("x1",x(mean)).attr("y1",cy-20).attr("x2",x(mean)).attr("y2",cy+20).attr("stroke","#2563EB").attr("stroke-width",3);g.append("text").attr("x",x(mean)).attr("y",cy-25).attr("text-anchor","middle").text(Mean: ).style("font-size","12px").style("font-weight","bold").style("fill","#2563EB")}scenarioBtn.addEventListener('click',runScenarioAnalysis);async function runScenarioAnalysis(){setScenarioLoading(!0);const fieldId=gId('field_id').value,crop=gId('crop').value.toLowerCase(),budgets=[5e3,7500,1e4,12500,15e3,17500,2e4];let jobPromises=[];showStatus(Submitting  jobs...);for(const b of budgets){const p=fetch('/recommend/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field_id:fieldId,budget:b,crop:crop})}).then(res=>res.json());jobPromises.push(p)}const jobRes=await Promise.all(jobPromises);showStatus(Polling  results...);let pollPromises=jobRes.map(job=>pollForResult(job.job_id));const results=await Promise.all(pollPromises);showStatus(Plotting  results.);scenarioChartContainer.classList.remove('hidden');drawParetoChart(results.map(res=>res.data));setScenarioLoading(!1);updateUI(results[results.length-1].data)} function pollForResult(jobId){return new Promise((resolve,reject)=>{const poll=async()=>{try{const res=await fetch(/recommend/result/),data=await res.json();if(data.status==='SUCCESS')resolve(data);else if(data.status==='FAILED')reject(new Error(data.data));else setTimeout(poll,3e3)}catch(err){reject(err)}};poll()})}function setScenarioLoading(isLoading){scenarioBtn.disabled=isLoading;scenarioBtnText.textContent=isLoading?"Running...":"Run Scenario Analysis";isLoading?scenarioLoader.classList.remove('hidden'):scenarioLoader.classList.add('hidden')}function drawParetoChart(results){paretoSvg.selectAll("*").remove();const m={t:20,r:30,b:50,l:60},w=600-m.l-m.r,h=300-m.t-m.b,g=paretoSvg.append("g").attr("transform",	ranslate(,)),x=d3.scaleLinear().domain([0,d3.max(results,d=>d.budget)*1.1]).range([0,w]);g.append("g").attr("transform",	ranslate(0, )).call(d3.axisBottom(x).ticks(5)).selectAll("text").style("font-size","12px");g.append("text").attr("text-anchor","middle").attr("x",w/2).attr("y",h+40).text("Budget (INR)");const y=d3.scaleLinear().domain([0,d3.max(results,d=>d.expected_yield_95_ci_high)*1.1]).range([h,0]);g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").style("font-size","12px");g.append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",-m.l+20).attr("x",-h/2).text("Expected Yield (kg/ha)");g.selectAll("error-bar").data(results).enter().append("line").attr("stroke","gray").attr("stroke-width",1.5).attr("x1",d=>x(d.budget)).attr("y1",d=>y(d.expected_yield_95_ci_low)).attr("x2",d=>x(d.budget)).attr("y2",d=>y(d.expected_yield_95_ci_high));g.selectAll("dot").data(results).enter().append("circle").attr("cx",d=>x(d.budget)).attr("cy",d=>y(d.expected_yield_mean)).attr("r",5).style("fill","#2563EB")}
</script></body></html>
